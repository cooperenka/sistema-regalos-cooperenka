<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Entrega de Regalos - Cooperenka</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .header-gradient {
            background: linear-gradient(135deg, #2E8B57 0%, #3CB371 100%);
            color: white;
            padding: 2rem 0;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .search-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            margin: 2rem 0;
        }
        .result-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            transition: box-shadow 0.2s;
        }
        .result-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .observation-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 0.75rem;
            border-radius: 5px;
            margin: 0.5rem 0;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .btn-cooperenka {
            background: #2E8B57;
            border-color: #2E8B57;
            color: white;
        }
        .btn-cooperenka:hover {
            background: #236B47;
            border-color: #236B47;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-gradient">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2"><i class="fas fa-gift"></i> Sistema de Entrega de Regalos</h1>
                    <h5 class="mb-0">Cooperenka - Gestión en Tiempo Real</h5>
                </div>
                <div class="col-md-4 text-end">
                    <div id="last-update" class="small"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="container mt-4">
        <div class="row" id="estadisticas">
            <div class="col-md-3 mb-3">
                <div class="stat-card text-center" style="border-left: 4px solid #007bff;">
                    <p class="stat-number text-primary" id="total">0</p>
                    <p class="mb-0">Total Asociados</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card text-center" style="border-left: 4px solid #28a745;">
                    <p class="stat-number text-success" id="entregados">0</p>
                    <p class="mb-0">Entregados</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card text-center" style="border-left: 4px solid #ffc107;">
                    <p class="stat-number text-warning" id="pendientes">0</p>
                    <p class="mb-0">Pendientes</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card text-center" style="border-left: 4px solid #dc3545;">
                    <p class="stat-number text-danger" id="novedades">0</p>
                    <p class="mb-0">Con Novedades</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegación por pestañas -->
    <div class="container mt-4">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button">
                    <i class="fas fa-search"></i> Buscar Asociado
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button">
                    <i class="fas fa-table"></i> Gestionar Registros
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button">
                    <i class="fas fa-upload"></i> Cargar Datos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button">
                    <i class="fas fa-file-pdf"></i> Reportes
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Búsqueda -->
            <div class="tab-pane fade show active" id="search" role="tabpanel">
                <div class="search-card">
                    <h4><i class="fas fa-search"></i> Buscar Asociado</h4>
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control form-control-lg" id="searchInput" 
                                   placeholder="Buscar por cédula o nombre..." autocomplete="off">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-cooperenka btn-lg w-100" onclick="buscarAsociados()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>

                <div id="searchResults"></div>
                <div class="loading" id="searchLoading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Buscando...</p>
                </div>
            </div>

            <!-- Gestión de registros -->
            <div class="tab-pane fade" id="manage" role="tabpanel">
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-table"></i> Gestión de Registros</h4>
                        <button class="btn btn-cooperenka" onclick="cargarRegistros()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="registrosTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cédula</th>
                                    <th>Nombre Completo</th>
                                    <th>Agencia</th>
                                    <th>Empresa</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="registrosBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Carga de datos -->
            <div class="tab-pane fade" id="upload" role="tabpanel">
                <div class="mt-4">
                    <h4><i class="fas fa-upload"></i> Cargar Archivo de Asociados</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Subir Archivo</h5>
                                    <form id="uploadForm" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <input type="file" class="form-control" id="fileInput" 
                                                   accept=".xlsx,.xls,.csv" required>
                                            <div class="form-text">Formatos: Excel (.xlsx, .xls) o CSV</div>
                                        </div>
                                        <button type="submit" class="btn btn-cooperenka">
                                            <i class="fas fa-upload"></i> Cargar Archivo
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Formato Requerido</h5>
                                    <p>El archivo debe contener las siguientes columnas:</p>
                                    <ul class="small">
                                        <li><strong>CEDULA:</strong> Número de cédula</li>
                                        <li><strong>APELLIDO 1:</strong> Primer apellido</li>
                                        <li><strong>APELLIDO 2:</strong> Segundo apellido</li>
                                        <li><strong>NOMBRE 1:</strong> Primer nombre</li>
                                        <li><strong>NOMBRE 2:</strong> Segundo nombre</li>
                                        <li><strong>AGENCIA:</strong> Agencia</li>
                                        <li><strong>EMPRESA:</strong> Empresa</li>
                                        <li><strong>OBSERVACIONES:</strong> Notas (opcional)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reportes -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="mt-4">
                    <h4><i class="fas fa-file-pdf"></i> Reportes y Exportación</h4>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                                    <h5>Exportar CSV</h5>
                                    <a href="/api/exportar/csv" class="btn btn-success">
                                        <i class="fas fa-download"></i> Descargar CSV
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                    <h5>Estadísticas</h5>
                                    <button class="btn btn-primary" onclick="mostrarEstadisticas()">
                                        <i class="fas fa-eye"></i> Ver Estadísticas
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-history fa-3x text-info mb-3"></i>
                                    <h5>Historial</h5>
                                    <button class="btn btn-info" onclick="mostrarHistorial()">
                                        <i class="fas fa-list"></i> Ver Historial
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cédula</label>
                                <input type="text" class="form-control" id="editCedula" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="editEstado">
                                    <option value="PENDIENTE">PENDIENTE</option>
                                    <option value="ENTREGADO">ENTREGADO</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Primer Nombre</label>
                                <input type="text" class="form-control" id="editNombre1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Segundo Nombre</label>
                                <input type="text" class="form-control" id="editNombre2">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Primer Apellido</label>
                                <input type="text" class="form-control" id="editApellido1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Segundo Apellido</label>
                                <input type="text" class="form-control" id="editApellido2">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Agencia</label>
                                <input type="text" class="form-control" id="editAgencia">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Empresa</label>
                                <input type="text" class="form-control" id="editEmpresa">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="editObservaciones" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-cooperenka" onclick="guardarEdicion()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let currentData = [];
        
        // Cargar estadísticas al inicio
        document.addEventListener('DOMContentLoaded', function() {
            cargarEstadisticas();
            cargarRegistros();
            
            // Búsqueda en tiempo real
            document.getElementById('searchInput').addEventListener('input', function() {
                if (this.value.length >= 2) {
                    buscarAsociados();
                } else if (this.value.length === 0) {
                    document.getElementById('searchResults').innerHTML = '';
                }
            });
            
            // Form de upload
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                subirArchivo();
            });
            
            // Actualizar cada 30 segundos
            setInterval(cargarEstadisticas, 30000);
        });
        
        // Cargar estadísticas
        function cargarEstadisticas() {
            fetch('/api/estadisticas')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total').textContent = data.total;
                    document.getElementById('entregados').textContent = data.entregados;
                    document.getElementById('pendientes').textContent = data.pendientes;
                    document.getElementById('novedades').textContent = data.novedades;
                    
                    document.getElementById('last-update').textContent = 
                        'Última actualización: ' + new Date().toLocaleTimeString();
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Buscar asociados
        function buscarAsociados() {
            const termino = document.getElementById('searchInput').value;
            if (!termino) return;
            
            document.getElementById('searchLoading').style.display = 'block';
            
            fetch(`/api/buscar?q=${encodeURIComponent(termino)}`)
                .then(response => response.json())
                .then(data => {
                    mostrarResultados(data);
                    document.getElementById('searchLoading').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('searchLoading').style.display = 'none';
                });
        }
        
        // Mostrar resultados de búsqueda
        function mostrarResultados(resultados) {
            const container = document.getElementById('searchResults');
            
            if (resultados.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No se encontraron resultados</div>';
                return;
            }
            
            let html = `<div class="mt-3"><h5>Resultados (${resultados.length})</h5>`;
            
            resultados.forEach(asociado => {
                const estadoClass = asociado.estado === 'ENTREGADO' ? 'success' : 'warning';
                const estadoIcon = asociado.estado === 'ENTREGADO' ? 'check-circle' : 'clock';
                
                html += `
                    <div class="result-card">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6><i class="fas fa-user"></i> ${asociado.nombre_completo}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-id-card"></i> ${asociado.cedula} | 
                                    <i class="fas fa-building"></i> ${asociado.agencia} | 
                                    <i class="fas fa-briefcase"></i> ${asociado.empresa}
                                </small>
                                ${asociado.observaciones ? 
                                    `<div class="observation-alert mt-2">
                                        <strong><i class="fas fa-exclamation-triangle"></i> Observaciones:</strong> 
                                        ${asociado.observaciones}
                                    </div>` : ''}
                            </div>
                            <div class="col-md-3 text-center">
                                <span class="badge bg-${estadoClass} fs-6">
                                    <i class="fas fa-${estadoIcon}"></i> ${asociado.estado}
                                </span>
                            </div>
                            <div class="col-md-3 text-end">
                                ${asociado.estado === 'PENDIENTE' ? 
                                    `<button class="btn btn-success btn-sm me-2" onclick="marcarEntregado(${asociado.id})">
                                        <i class="fas fa-check"></i> Entregar
                                    </button>` : ''}
                                <button class="btn btn-primary btn-sm" onclick="editarAsociado(${asociado.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Marcar como entregado
        function marcarEntregado(id) {
            if (!confirm('¿Confirma que desea marcar este regalo como entregado?')) return;
            
            fetch(`/api/entregar/${id}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        buscarAsociados();
                        cargarEstadisticas();
                        cargarRegistros();
                        alert('Regalo marcado como entregado');
                    }
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Cargar registros para la tabla
        function cargarRegistros() {
            fetch('/api/asociados')
                .then(response => response.json())
                .then(data => {
                    currentData = data;
                    mostrarTablaRegistros(data);
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Mostrar tabla de registros
        function mostrarTablaRegistros(data) {
            const tbody = document.getElementById('registrosBody');
            
            tbody.innerHTML = data.map(asociado => {
                const estadoClass = asociado.estado === 'ENTREGADO' ? 'success' : 'warning';
                const estadoIcon = asociado.estado === 'ENTREGADO' ? 'check-circle' : 'clock';
                
                return `
                    <tr>
                        <td>${asociado.cedula}</td>
                        <td>${asociado.nombre_completo}</td>
                        <td>${asociado.agencia}</td>
                        <td>${asociado.empresa}</td>
                        <td>
                            <span class="badge bg-${estadoClass}">
                                <i class="fas fa-${estadoIcon}"></i> ${asociado.estado}
                            </span>
                        </td>
                        <td>
                            ${asociado.estado === 'PENDIENTE' ? 
                                `<button class="btn btn-success btn-sm me-1" onclick="marcarEntregado(${asociado.id})" title="Marcar como entregado">
                                    <i class="fas fa-check"></i>
                                </button>` : ''}
                            <button class="btn btn-primary btn-sm" onclick="editarAsociado(${asociado.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>`;
            }).join('');
        }
        
        // Editar asociado
        function editarAsociado(id) {
            const asociado = currentData.find(a => a.id === id);
            if (!asociado) return;
            
            document.getElementById('editId').value = asociado.id;
            document.getElementById('editCedula').value = asociado.cedula;
            document.getElementById('editNombre1').value = asociado.nombre1;
            document.getElementById('editNombre2').value = asociado.nombre2;
            document.getElementById('editApellido1').value = asociado.apellido1;
            document.getElementById('editApellido2').value = asociado.apellido2;
            document.getElementById('editAgencia').value = asociado.agencia;
            document.getElementById('editEmpresa').value = asociado.empresa;
            document.getElementById('editObservaciones').value = asociado.observaciones || '';
            document.getElementById('editEstado').value = asociado.estado;
            
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }
        
        // Guardar edición
        function guardarEdicion() {
            const id = document.getElementById('editId').value;
            const data = {
                nombre1: document.getElementById('editNombre1').value,
                nombre2: document.getElementById('editNombre2').value,
                apellido1: document.getElementById('editApellido1').value,
                apellido2: document.getElementById('editApellido2').value,
                agencia: document.getElementById('editAgencia').value,
                empresa: document.getElementById('editEmpresa').value,
                observaciones: document.getElementById('editObservaciones').value,
                estado: document.getElementById('editEstado').value
            };
            
            fetch(`/api/editar/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    cargarRegistros();
                    cargarEstadisticas();
                    alert('Registro actualizado correctamente');
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        // Subir archivo
        function subirArchivo() {
            const formData = new FormData();
            const fileInput = document.getElementById('fileInput');
            formData.append('file', fileInput.files[0]);
            
            fetch('/api/cargar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    cargarRegistros();
                    cargarEstadisticas();
                    fileInput.value = '';
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al subir archivo');
            });
        }
        
        // Mostrar estadísticas detalladas
        function mostrarEstadisticas() {
            fetch('/api/estadisticas')
                .then(response => response.json())
                .then(data => {
                    const porcentajeEntregados = data.total > 0 ? ((data.entregados / data.total) * 100).toFixed(1) : 0;
                    const porcentajePendientes = data.total > 0 ? ((data.pendientes / data.total) * 100).toFixed(1) : 0;
                    
                    alert(`📊 ESTADÍSTICAS DETALLADAS
                    
Total de Asociados: ${data.total}
Regalos Entregados: ${data.entregados} (${porcentajeEntregados}%)
Regalos Pendientes: ${data.pendientes} (${porcentajePendientes}%)
Registros con Novedades: ${data.novedades}

Progreso de entregas: ${porcentajeEntregados}%`);
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Mostrar historial
        function mostrarHistorial() {
            fetch('/api/asociados')
                .then(response => response.json())
                .then(data => {
                    const entregados = data.filter(a => a.estado === 'ENTREGADO' && a.fecha_entrega);
                    
                    if (entregados.length === 0) {
                        alert('No hay entregas registradas aún.');
                        return;
                    }
                    
                    let historial = '📈 HISTORIAL DE ENTREGAS\n\n';
                    entregados.forEach(asociado => {
                        historial += `• ${asociado.nombre_completo}\n`;
                        historial += `  Cédula: ${asociado.cedula}\n`;
                        historial += `  Fecha: ${asociado.fecha_entrega}\n`;
                        historial += `  Agencia: ${asociado.agencia}\n\n`;
                    });
                    
                    alert(historial);
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>